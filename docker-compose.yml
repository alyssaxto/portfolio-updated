services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    volumes:
      - ./api:/home/site/wwwroot
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - AzureWebJobsStorage=UseDevelopmentStorage=true
    ports:
      - "7071:7071"

  frontend:
    image: node:18-alpine
    working_dir: /app/frontend # Point this to your frontend folder
    volumes:
      - .:/app
      - /app/frontend/node_modules # Protect the container's node_modules
    environment:
      - NODE_ENV=development
    ports:
      - "5173:5173" # Vite default port
    # The --host flag is required for Vite to be accessible outside the container
    command: sh -c "npm install && npm run dev -- --host"

  swa:
    image: node:18-alpine
    working_dir: /app
    ports:
      - "4280:4280"
    # This installs the SWA CLI and then runs it
    command: sh -c "npm install -g @azure/static-web-apps-cli && swa start http://frontend:5173 --api-location http://api:7071 --host 0.0.0.0"
    depends_on:
      - frontend
      - api